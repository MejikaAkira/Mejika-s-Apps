# RealTImeAnimation
ルート: `C:\\Users\\megap\\AI\\RealTImeAnimation`

## プロジェクト概要
- **目的**: 外部からの UDP ストリーム(各 Node 点の時系列振幅)を受信し、基準形状(位相0)に対して各 Node の変位を反映し、Three.js でリアルタイム可視化する。
- **想定ユースケース**: 異常検知モニタリング

## スコープ
- **含む**: UDP 受信、データバッファリング/補間、ノード変位の適用、Three.js 表示、操作UI(回転/拡大縮小/再生停止/スケール調整)、ログ/メトリクス、簡易記録/再生、設定ファイル。
- **含まない(初期版)**: 複雑なメッシュスキニング、有限要素ポスト処理、マルチモード同時合成(将来拡張)。

## システム構成(概略)
- **IPC**: ノード振幅データを UDP 送信。
- **受信/変換**: UDP → RingBuffer(最新優先) → 正規化/スケール → 補間。
- **可視化**: Three.js で基準ジオメトリに対し各 Node の変位を適用しレンダリング。OrbitControls による 360° 操作。
- **設定**: `config.json` でネットワーク/ノード/スケール/スムージング等を外部化。

## 入出力仕様（現行）
- **ネットワーク**: UDP/IPv4, 受信ポート既定: 1500（1501 も使用可）
- **送信周期**: 任意。推奨は周波数 f に対し `Rate ≥ 20×f`
- **時刻基準**: 送信側タイムスタンプ（マイクロ秒 `t_us:uint64`）
- **パケット構造**:
  - ヘッダ: `<seq:uint32><t_us:uint64><count:uint16>`
  - ペイロード: `float32[count]`（ノード ID は 0..count-1）
  - エンディアン: Little Endian
- **喪失/順序**: ロス/順序入替を許容。2D は送信時刻に従い描画、3D は最新値のみ保持。

## ノード/ジオメトリ仕様
- **基準形状**: 位相0のジオメトリ(例: GLTF/GLB または JSON)。
- **ノード定義**: `nodeId`, `position:[x,y,z]`, `direction:[nx,ny,nz]`(変位方向/モード形状方向)、任意で `weight`。
- **対応付け**: `nodeId` → メッシュ上の最近傍頂点/ウェイト/ボーン等。初期版は頂点の最近傍/バリデーション用に色付与可。

## 変形アルゴリズム(初期版)
- 時刻 t の各 `nodeId` の振幅 `A(node,t)` を方向ベクトルに沿って適用: `pos' = pos0 + scale * A(node,t) * direction`。
- ノード間の空間補間: 逆距離重み(IDW)または最近傍。初期版は最近傍優先、オプションで IDW。
- 時間補間: 受信レートと描画レート差を緩和する線形補間(リングバッファ内の前後サンプル間)。
- スムージング: オプションで移動平均/指数平滑。遅延とのトレードオフを設定可能。

## パフォーマンス/レイテンシ要件(目標値)
- E2E レイテンシ(受信→描画) < 50 ms(理想)、< 100 ms(許容)。
- フレームレート: 60 FPS 目標(最小 30 FPS)。
- パケットロス 1% 未満で視覚的破綻がないこと(ホールド/補間で吸収)。

## 可視化/UI 要件
- Three.js + OrbitControls による 360°回転/パン/ズーム。
- UI: 再生/一時停止、変位スケール、色マップ(振幅→色)の有効/無効、座標軸/グリッドの表示切替。
- オーバーレイ: FPS、受信レート、ロス率、最新時刻。

## 設定/構成ファイル
- `viewer/config.json` 例:
```
{
  "nodes": { "count": 21 },
  "udp": { "port": 1500, "mode": "loopback", "nic_ip": "10.8.1.100", "max_hz": 2000.0 }
}
```
備考: 実際の JS 反映は約 60Hz でバッチ/最新のみ送信（`viewer.py` の `graph_update_hz`/`anim_update_hz`）。

## ログ/診断
- ログ: コンソール + 任意のファイル出力(レベル: info/warn/error)。
- メトリクス: 受信pps、ロス率、描画fps、遅延推定値。

## エラーハンドリング
- 受信停止タイムアウト(例: > 500 ms)で自動一時停止表示。
- 異常パケット(サイズ不整合/NaN)は破棄し警告。
- ノード未定義は無視し統計に計上。

## セキュリティ/運用
- `.\open_udp1500_and_run_viewer.bat` を管理者として実行。起動時に Firewall 許可を作成し、終了時に削除します。

## セットアップ/実行手順 (venv 推奨)
- 前提: Python 3.10+ (Windows PowerShell)
- 初回セットアップ:
  - 仮想環境作成: `python -m venv venv`
  - 有効化: `./venv/Scripts/Activate.ps1`
  - 依存インストール: `pip install -r requirements.txt`
- 起動: 管理者で `open_udp1500_and_run_viewer.bat`

## テスト計画(簡易 15 ノード)
- **目的**: IPC がなくても描画/補間/UI/メトリクスを確認。
- **方法**:
  - 15 ノードを正多角形/格子上に配置。
  - 各ノードに任意のサイン波 `A_i(t) = a_i sin(2π f_i t + φ_i)` を付与(周波数/位相をずらす)。
  - UDP 代替: `send_udp_gui.py` で擬似送信(Loopback 127.0.0.1:1500)。
  - Three.js で 360°回転操作、変位スケール/色マップ確認。
- **合格基準**:
  - 60 FPS 近傍で滑らかに更新。
  - 変位スケール0で静止、スケール変更で線形に変化。
  - 一時停止/再開が即応。
  - メトリクスが妥当値を表示。

## 今後の拡張
- 複数モードの重ね合わせ、モード寄与率の操作。
- GLTF スキニング/モーフターゲット連携。
- 記録/再生(PCAP/バイナリ)とオフライン解析。
- ノード→メッシュ減衰補間の高速化(GPU シェーダ/テクスチャベイク)。
